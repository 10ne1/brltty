#!/bin/bash
###############################################################################
# BRLTTY - A background process providing access to the console screen (when in
#          text mode) for a blind person using a refreshable braille display.
#
# Copyright (C) 1995-2021 by The BRLTTY Developers.
#
# BRLTTY comes with ABSOLUTELY NO WARRANTY.
#
# This is free software, placed under the terms of the
# GNU Lesser General Public License, as published by the Free Software
# Foundation; either version 2.1 of the License, or (at your option) any
# later version. Please see the file LICENSE-LGPL for details.
#
# Web Page: http://brltty.app/
#
# This software is maintained by Dave Mielke <dave@mielke.cc>.
###############################################################################

# Braille drivers already disabled:
# lb (by --without-libbraille)
# xw (by --disable-x)
readonly configureOptions=(
   --disable-expat
   --disable-gpm
   --disable-iconv
   --disable-icu
   --disable-liblouis
   --disable-polkit
   --disable-x

   --without-libbraille
   --with-braille-driver=-ba,-bg,-tt,-vr,al,at,bm,bn,ce,eu,fs,hm,ht,hw,ic,ir,md,mm,mt,np,pg,pm,sk,vo

   --without-espeak
   --without-espeak-ng
   --without-flite
   --without-mikropuhe
   --without-speechd
   --without-swift
   --without-theta
   --with-speech-driver=an,-all

   --with-screen-driver=an,-all

   --without-pgmpath-package
   --without-pgmprivs-package
   --without-service-package
   --without-params-package
   --without-charset-package
   --without-rgx-package
   --without-hostcmd-package
   --without-mntpt-package
   --without-mntfs-package
   --without-bell-package
   --without-leds-package
   --without-beep-package
   --without-midi-package
   --without-fm-package
   --without-ports-package
)

. "`dirname "${0}"`/brltty-prologue.sh"
set -e

checkTool() {
   eval export "${1}=\`set -- \"${toolchainBinaries}/\"*\"-$2\" && echo \"\${1}\"\`"
}

configureABI() {
   local abiRoot="${1}"
   . "${abiRoot}/build.properties"

   export toolchainBinaries="${BRLTTY_ANDROID_TOOLCHAIN}/bin"
   export PATH="${PATH}:${toolchainBinaries}"
   checkTool CC gcc

   export CFLAGS="${BRLTTY_ANDROID_CFLAGS}"
   export LDFLAGS="${BRLTTY_ANDROID_LDFLAGS}"

   "${BRLTTY_ANDROID_SOURCE}/configure" --quiet --host="${BRLTTY_ANDROID_SYSTEM}" "${configureOptions[@]}"
}

sourceRoot="${programDirectory}"
buildRoot="${initialDirectory}"

androidRoot="${buildRoot}/Android"
ndkRoot="${androidRoot}/NDK"

[ -d "${ndkRoot}" ] || {
   [ -n "${ANDROID_NDK}" ] || {
      semanticError "Android NDK directory not defined: ${ndkRoot}"
   }

   [  -f "${ANDROID_NDK}/ndk-build" ] || {
      semanticError "not an Android NDK: ${ANDROID_NDK}"
   }

   programMessage "creating symbolic link: ${ndkRoot} -> ${ANDROID_NDK}"
   ln -s "${ANDROID_NDK}" "${ndkRoot}" || exit "${?}"
}

architecturesRoot="${androidRoot}/ABI"
androidPlatform=android-21

prepareArchitecture() {
   local architecture="${1}"
   local system="${2}"
   local abi="${3}"
   local cFlags="${4}"
   local ldFlags="${5}"

   local abiRoot="${architecturesRoot}/${abi}"
   mkdir -p -- "${abiRoot}"
   local toolchainRoot="${abiRoot}/ToolChain"

   [ -d "${toolchainRoot}" ] || {
      "${ndkRoot}/build/tools/make-standalone-toolchain.sh" \
         --platform="${androidPlatform}" \
         --arch="${architecture}" \
         --install-dir="${toolchainRoot}" || exit "${?}"

      local buildInclude="/usr/include"
      local hostInclude="${toolchainRoot}/sysroot${buildInclude}"

      local header
      for header in bluetooth
      do
         local hostHeader="${hostInclude}/${header}"
         [ ! -e "${hostHeader}" ] || continue

         local buildHeader="${buildInclude}/${header}"
         [ -e "${buildHeader}" ] || continue

         ln -s "${buildHeader}" "${hostHeader}" || exit "${?}"
      done
   }

   (  set -e
      cd "${abiRoot}"

      set -- SOURCE "${sourceRoot}" PLATFORM "${androidPlatform}" ARCH "${architecture}" ABI "${abi}" SYSTEM "${system}" TOOLCHAIN "${toolchainRoot}" CFLAGS "${cFlags}" LDFLAGS "${ldFlags}"
      local variablesFile="build.properties"
      : >"${variablesFile}"

      while [ "${#}" -gt 0 ]
      do
         local variable="${1}"
         local value="${2}"
         shift 2
         echo >>"${variablesFile}" "BRLTTY_ANDROID_${variable}=${value}"
      done
   )
}

prepareArchitecture arm arm-linux-androideabi armeabi-v7a "-mthumb" "-Wl,--fix-cortex-a8"
prepareArchitecture arm64 aarch64-linux-android arm64-v8a
prepareArchitecture x86 i686-linux-android x86
prepareArchitecture x86_64 x86_64-linux-android x86_64

configureABI "${architecturesRoot}/armeabi-v7a"
exit 0
